'use server'

import { revalidatePath } from 'next/cache'
import { S3Client, PutObjectCommand, DeleteObjectCommand, GetObjectCommand, ListObjectsV2Command } from '@aws-sdk/client-s3'

// お知らせデータの型定義
export interface Announcement {
  id: string;
  title: string;
  category: "試験情報" | "お知らせ";
  content: string;
  isPublished: boolean;
  createdAt: string;
  updatedAt: string;
}

// カテゴリ名をディレクトリ名にマッピング
const categoryDirMap: Record<string, string> = {
  "試験情報": "exam",
  "お知らせ": "news",
}

// S3 設定（環境変数）
const S3_BUCKET_NAME = process.env.S3_BUCKET_NAME
const AWS_REGION = process.env.AWS_REGION
const AWS_ACCESS_KEY_ID = process.env.AWS_ACCESS_KEY_ID
const AWS_SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY

// S3 クライアント
if (!S3_BUCKET_NAME || !AWS_REGION || !AWS_ACCESS_KEY_ID || !AWS_SECRET_ACCESS_KEY) {
  throw new Error('S3 configuration is required')
}

const s3Client = new S3Client({
  region: AWS_REGION,
  credentials: {
    accessKeyId: AWS_ACCESS_KEY_ID,
    secretAccessKey: AWS_SECRET_ACCESS_KEY,
  },
})

// タイトルをファイル名に適した形式に変換
function convertToSlug(title: string): string {
  return title
    .trim()
    .replace(/\s+/g, '')
    .replace(/[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF-]/g, '')
    .slice(0, 50);
}

// S3でファイルが存在するかチェック
async function s3FileExists(key: string): Promise<boolean> {
  try {
    await s3Client.send(new GetObjectCommand({
      Bucket: S3_BUCKET_NAME!,
      Key: key,
    }))
    return true
  } catch {
    return false
  }
}

// タイトルとカテゴリからIDを生成
async function generateUniqueId(title: string, category: string): Promise<string> {
  const date = new Date()
  const dateStr = date.getFullYear() 
    + String(date.getMonth() + 1).padStart(2, '0') 
    + String(date.getDate()).padStart(2, '0')
  
  const slug = convertToSlug(title)
  const baseSlug = slug || 'untitled'
  const categoryDir = categoryDirMap[category] || 'news'
  
  let filename = `${dateStr}--${baseSlug}`
  let counter = 1
  
  // 同じファイル名が存在する場合は番号を付ける
  while (await s3FileExists(`local/announcements/${categoryDir}/${filename}.json`)) {
    filename = `${dateStr}--${baseSlug}-${counter}`
    counter++
  }
  
  return `${categoryDir}/${filename}`
}

// 既存のIDから日付部分を抽出
function extractDateFromId(id: string): string {
  const parts = id.split('/')
  const filename = parts[parts.length - 1]
  const match = filename.match(/^(\d{8})--/)
  return match ? match[1] : ''
}

// タイトルとカテゴリから新しいIDを生成（日付は既存のものを使用）
async function generateUpdatedId(
  oldId: string,
  newTitle: string,
  newCategory: string
): Promise<string> {
  const dateStr = extractDateFromId(oldId)
  
  if (!dateStr) {
    return generateUniqueId(newTitle, newCategory)
  }
  
  const slug = convertToSlug(newTitle)
  const baseSlug = slug || 'untitled'
  const categoryDir = categoryDirMap[newCategory] || 'news'
  
  let filename = `${dateStr}--${baseSlug}`
  let counter = 1
  
  const oldS3Key = `local/announcements/${oldId}.json`
  while (await s3FileExists(`local/announcements/${categoryDir}/${filename}.json`)) {
    const checkKey = `local/announcements/${categoryDir}/${filename}.json`
    if (checkKey === oldS3Key) {
      break
    }
    filename = `${dateStr}--${baseSlug}-${counter}`
    counter++
  }
  
  return `${categoryDir}/${filename}`
}

// S3 に JSON をアップロード
async function uploadJsonToS3(key: string, json: string) {
  const cmd = new PutObjectCommand({
    Bucket: S3_BUCKET_NAME!,
    Key: key,
    Body: Buffer.from(json, 'utf-8'),
    ContentType: 'application/json; charset=utf-8',
  })
  await s3Client.send(cmd)
  return `https://${S3_BUCKET_NAME}.s3.${AWS_REGION}.amazonaws.com/${encodeURIComponent(key)}`
}

// S3からJSONを取得
async function getJsonFromS3(key: string): Promise<string | null> {
  try {
    const cmd = new GetObjectCommand({
      Bucket: S3_BUCKET_NAME!,
      Key: key,
    })
    const response = await s3Client.send(cmd)
    const body = await response.Body?.transformToString()
    return body || null
  } catch {
    return null
  }
}

// お知らせを作成
export async function createAnnouncement(
  data: Omit<Announcement, "id" | "createdAt" | "updatedAt">
) {
  console.log("createAnnouncement called with data:", data);
  try {
    const id = await generateUniqueId(data.title, data.category)
    console.log("Generated ID:", id);
    
    const newAnnouncement: Announcement = {
      ...data,
      id: id,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    }

    const json = JSON.stringify(newAnnouncement, null, 2)
    const s3Key = `local/announcements/${id}.json`
    const s3Url = await uploadJsonToS3(s3Key, json)
    console.log('Uploaded announcement to S3:', s3Key)

    try {
      revalidatePath('/announcements')
      revalidatePath('/admin/announcements')
    } catch (e) {
      console.warn('revalidatePath warning:', e)
    }

    return { success: true, data: newAnnouncement, url: s3Url }
  } catch (error) {
    console.error('Failed to create announcement:', error)
    return { success: false, error: 'お知らせの作成に失敗しました' }
  }
}

// すべてのお知らせを取得
export async function getAnnouncements(): Promise<Announcement[]> {
  try {
    const announcements: Announcement[] = []
    
    // S3からすべてのお知らせファイルを取得
    const listCmd = new ListObjectsV2Command({
      Bucket: S3_BUCKET_NAME!,
      Prefix: 'local/announcements/',
    })
    
    const response = await s3Client.send(listCmd)
    
    if (response.Contents) {
      for (const obj of response.Contents) {
        if (obj.Key && obj.Key.endsWith('.json')) {
          const content = await getJsonFromS3(obj.Key)
          if (content) {
            announcements.push(JSON.parse(content) as Announcement)
          }
        }
      }
    }

    // 作成日時の降順でソート
    return announcements.sort((a, b) => 
      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    )
  } catch (error) {
    console.error('Failed to get announcements:', error)
    return []
  }
}

// 公開中のお知らせのみ取得
export async function getPublishedAnnouncements(): Promise<Announcement[]> {
  const announcements = await getAnnouncements()
  return announcements.filter(a => a.isPublished)
}

// IDでお知らせを取得
export async function getAnnouncementById(id: string): Promise<Announcement | null> {
  try {
    const s3Key = `local/announcements/${id}.json`
    const content = await getJsonFromS3(s3Key)
    if (!content) return null
    return JSON.parse(content) as Announcement
  } catch (error) {
    console.error('Failed to get announcement:', error)
    return null
  }
}

// お知らせを更新
export async function updateAnnouncement(
  id: string,
  updates: Partial<Omit<Announcement, "id" | "createdAt">>
) {
  try {
    const existing = await getAnnouncementById(id)
    if (!existing) {
      return { success: false, error: 'お知らせが見つかりません' }
    }

    const titleChanged = updates.title && updates.title !== existing.title
    const categoryChanged = updates.category && updates.category !== existing.category
    
    let newId = id
    let needsRename = titleChanged || categoryChanged

    if (needsRename) {
      const newTitle = updates.title || existing.title
      const newCategory = updates.category || existing.category
      newId = await generateUpdatedId(id, newTitle, newCategory)
      console.log('Renaming announcement:', { oldId: id, newId })
    }

    const updated: Announcement = {
      ...existing,
      ...updates,
      id: newId,
      updatedAt: new Date().toISOString(),
    }

    const json = JSON.stringify(updated, null, 2)

    if (needsRename && newId !== id) {
      // 古いS3ファイルを削除
      try {
        const oldS3Key = `local/announcements/${id}.json`
        await s3Client.send(new DeleteObjectCommand({
          Bucket: S3_BUCKET_NAME!,
          Key: oldS3Key,
        }))
        console.log('Deleted old S3 file:', oldS3Key)
      } catch (err) {
        console.error('Failed to delete old S3 file:', err)
      }

      // 新しいS3ファイルをアップロード
      const newS3Key = `local/announcements/${newId}.json`
      await uploadJsonToS3(newS3Key, json)
      console.log('Uploaded new S3 file:', newS3Key)
    } else {
      // S3ファイルを上書き
      const s3Key = `local/announcements/${id}.json`
      await uploadJsonToS3(s3Key, json)
      console.log('Updated announcement on S3:', s3Key)
    }

    revalidatePath('/announcements')
    revalidatePath('/news')
    revalidatePath(`/announcements/${id}`)
    revalidatePath(`/announcements/${newId}`)
    revalidatePath('/admin/announcements')

    return { success: true, data: updated, newId }
  } catch (error) {
    console.error('Failed to update announcement:', error)
    return { success: false, error: 'お知らせの更新に失敗しました' }
  }
}

// お知らせを削除
export async function deleteAnnouncement(id: string) {
  try {
    const s3Key = `local/announcements/${id}.json`
    await s3Client.send(new DeleteObjectCommand({
      Bucket: S3_BUCKET_NAME!,
      Key: s3Key,
    }))
    console.log('Deleted announcement from S3:', id)

    revalidatePath('/announcements')
    revalidatePath('/admin/announcements')

    return { success: true }
  } catch (error) {
    console.error('Failed to delete announcement:', error)
    return { success: false, error: 'お知らせの削除に失敗しました' }
  }
}
